<!doctype html>
<html>

    <head>
        <title>Berlin Freir√§ume</title>

        <meta charset="utf-8">

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
        <script src="js/bower_components/underscore/underscore-min.js"></script>
        <script src="js/bower_components/handlebars/handlebars.min.js"></script>

        <link rel="stylesheet" href="css/style.min.css" />
        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
        <!--[if lte IE 8]>
            <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.ie.css" />
        <![endif]-->
        <script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>

        <script src="js/filters.js"></script>

        <script id="filter-item-child-template" type="text/x-handlebars-template">
            {{#if filter.items}}
            <div class="icon"></div>
            {{/if}}

            {{#if filter.databaseField}}
                <input id="{{filter.databaseField}}" name="{{filter.databaseField}}" checked="checked" type="checkbox" />
            {{else}}
                <input id="{{filter.display}}" checked="checked" type="checkbox" />
            {{/if}}

            {{#if filter.display}}
                <label for="{{filter.databaseField}}">{{filter.display}}</label>
            {{/if}}
        </script>

        <script id="list-template" type="text/x-handlebars-template">
            <ul>
                {{#each places}}
                {{#with this.properties}}
                {{#if name_of_space}}
                <li class="list-place">
                    <a href="#" data-cartodbid="{{cartodb_id}}">{{name_of_space}}, {{address}}</a>
                </li>
                {{/if}}
                {{/with}}
                {{/each}}
            </ul>
        </script>

        <script id="popup-template" type="text/x-handlebars-template">
            <div class="place-popup-content">
                <h2>{{place.properties.name_of_space}}</h2>
                {{#if place.properties.website}}
                <a href="{{place.properties.website}}" target="_blank">website</a>
                {{/if}}

                {{#if place.properties.photo_url}}
                <a href="{{place.properties.photo_url}}" target="_blank">
                    <img class="place-image" src="{{place.properties.photo_url}}" />
                </a>
                {{/if}}

                {{video_link place.properties.video}}

                <ul>
                    {{#each selectedProperties}}
                    <li>{{this}}</li>
                    {{/each}}
                </ul>
            </div>
        </script>

        <script>

            (function (window, $, undefined) {
                "use strict";

                $.freespacemap = function(options, element) {
                    this.element = $(element);
                    if (!this._create(options)) {
                        this.failed = true;
                    }
                };

                $.freespacemap.defaults = {
                    center: [52.500556, 13.398889],

                    filters: null,

                    leafletApiKey: '781b27aa166a49e1a398cd9b38a81cdf',
                    leafletStyleId: '9986',

                    zoom: 10,
                };

                $.freespacemap.prototype = {

                    map: null,

                    style: {
                        fillColor: '#F04848',
                        fillOpacity: 1,
                        radius: 4,
                        stroke: false,

                        //stroke: true,
                        //strokeColor: '#000000',
                    },

                    allFilters: mapFilters,

                    currentFilters: [],

                    _create: function(options) {
                        // Add custom options to defaults
                        var opts = $.extend(true, {}, $.freespacemap.defaults, options);
                        this.options = opts;
                        var $window = $(window);
                        var instance = this;

                        instance._initializeMap();
                        instance._initializeFilters();

                        return true;
                    },

                    _initializeMap: function() {
                        var instance = this;

                        instance.map = L.map('map', {
                            center: instance.options.center,
                            zoom: instance.options.zoom,   
                        });

                        // add tile layer
                        L.tileLayer('http://{s}.tile.cloudmade.com/' 
                                + instance.options.leafletApiKey +'/' + instance.options.leafletStyleId
                                + '/256/{z}/{x}/{y}.png', {
                            attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery &copy; <a href="http://cloudmade.com">CloudMade</a>',
                            maxZoom: 18,
                        }).addTo(instance.map);

                        $.getJSON('http://newagebeverages.cartodb.com/api/v2/sql?format=GeoJSON&q=SELECT * FROM potentialities_map_v3', function(data) {
                            L.geoJson(data, {

                                onEachFeature: function(featureData, layer) {
                                    layer.on('click', function(e) {
                                        var properties = _.filter(instance.currentFilters, function(filter) {
                                            return featureData.properties[filter] !== 'No';
                                        });

                                        // precompile
                                        var source = $('#popup-template').html();
                                        var template = Handlebars.compile(source);
                                        var content = template({
                                            place: featureData,
                                            selectedProperties: properties,
                                        });
                                        layer.bindPopup(content, {
                                            minWidth: 300,   
                                            maxHeight: 450,
                                        }).openPopup();
                                    });
                                },

                                pointToLayer: function(feature, latlng) {
                                    return L.circleMarker(latlng, instance.style);
                                },

                            }).addTo(instance.map);

                            var sortedFeatures = _.sortBy(data.features, function(f) {
                                return f.properties.name_of_space;
                            });

                            var source = $('#list-template').html();
                            var template = Handlebars.compile(source);
                            $('#list').html(template({
                                places: sortedFeatures,
                            }));

                            $('.list-place a').click(function(e) {
                                e.preventDefault();
                                var clicked_id = $(this).data('cartodbid');
                                var clicked_layer = _.find(instance.map._layers, function(layer) {
                                    if (!layer.feature) return false;
                                    return layer.feature.properties.cartodb_id === clicked_id;
                                });

                                clicked_layer.fire('click');
                                return false;
                            });
                        });

                    },

                    _initializeFilters: function() {
                        var instance = this;

                        var addFilter = function(filter, position) {

                            // TODO precompile
                            var source = $('#filter-item-child-template').html();
                            var template = Handlebars.compile(source);
                            var inside = template({ filter: filter });

                            var $category_li = $('<li></li>');
                            $category_li
                                .html(inside);
                            $(position).append($category_li);

                            if (filter.items) {
                                // top-level category
                                $category_li.addClass('category');
                                // create subcategories ul
                                var $ul = $('<ul></ul>').addClass('subcategories');

                                // append everything to new ul
                                $.each(filter.items, function(i, item) {
                                    addFilter(item, $ul);
                                });

                                // append ul to position
                                $($category_li).append($ul);
                            }
                            else {
                                // subcategory
                                $category_li.addClass('subcategory');
                            }
                        };

                        $.each(instance.allFilters, function(i, filter) {
                            addFilter(filter, instance.options.filters);
                        });
                    },

                    updateFilters: function(filters) {
                        var instance = this;
                        instance.currentFilters = [];

                        var grow = $('#grow').is(':checked');

                        $.each(filters, function(i, filter) {
                            instance.currentFilters.push(filter.name);
                        });

                        // update display
                        $.each(instance.map._layers, function(i, layer) {
                            if (!layer.feature) return;

                            var layerFilters = _.filter(instance.currentFilters, function(filter) {
                                var filterValue = layer.feature.properties[filter];
                                return filterValue && filterValue !== '' && filterValue !== 'No';
                            });
                            if (layerFilters.length > 0) {
                                // show
                                layer.setStyle(instance.style);
                                if (grow) {
                                    layer.setStyle({ radius: layerFilters.length * 2 });
                                }
                            }
                            else {
                                // hide
                                layer.setStyle({ radius: 0, stroke: false, });
                            }
                        });
                    },

                };

                $.fn.freespacemap = function(options) {
                    var thisCall = typeof options;

                    switch (thisCall) {

                        // method 
                        case 'string':
                            var args = Array.prototype.slice.call(arguments, 1);

                            //this.each(function() {

                                var instance = $.data(this[0], 'freespacemap');

                                if (!instance) {
                                    // not setup yet
                                    return $.error('Method ' + options + 
                                        ' cannot be called until freespacemap is setup');
                                }

                                if (!$.isFunction(instance[options]) || options.charAt(0) === "_") {
                                    return $.error('No such method ' + options + ' for freespacemap');
                                }

                                // no errors!
                                return instance[options].apply(instance, args);
                            //});

                            break;

                        // creation 
                        case 'object':

                            this.each(function () {
                                var instance = $.data(this, 'freespacemap');

                                if (instance) {
                                    // update options of current instance
                                    instance.update(options);
                                } else {
                                    // initialize new instance
                                    instance = new $.freespacemap(options, this);

                                    // don't attach if instantiation failed
                                    if (!instance.failed) {
                                        $.data(this, 'freespacemap', instance);
                                    }
                                }
                            });

                            break;
                    }

                    return this;
                };

            })(window, jQuery);


            function onFilterChange() {
                $('#map').freespacemap('updateFilters', $('.filters :input').serializeArray());
            }

            function doWithoutFilterEvents(fn) {
                // temporarily stop handling onChange
                $('.filters input').off('change', onFilterChange);
                
                fn();

                // start handling onChange again
                $('.filters input').on('change', onFilterChange);
            }

            Handlebars.registerHelper('video_link', function(videoValue) {
                if (!videoValue || videoValue === 'No' || videoValue === 'no') return '';
                if (videoValue.indexOf('youtube') === -1) {
                    return new Handlebars.SafeString('<a href="' + videoValue + '" target="_blank">video</a>');
                }
                return new Handlebars.SafeString('<iframe width="300" height="169" src="' + videoValue + '" frameborder="0" allowfullscreen></iframe>');
            });

            $(document).ready(function() {
                $('#map').freespacemap({
                    filters: $('.filters'),
                });


                // hide subcategories
                $('.subcategories').slideUp();

                $('.filters input').change(onFilterChange);

                $('#grow').change(onFilterChange);


                /*
                 * Select/de-select top-level category.
                 */
                $('.category > :checkbox').change(function() {
                    var $subcategories_ul = $(this).parent().find('ul');
                    var $subcategories_checkboxes = $subcategories_ul.find(':checkbox');

                    if (this.checked) {
                        doWithoutFilterEvents(function() {
                            $subcategories_checkboxes.not(':checked').trigger('click');

                            // call onChange handler manually
                            onFilterChange();
                        });
                    }
                    else {
                        doWithoutFilterEvents(function() {
                            $subcategories_checkboxes.filter(':checked').trigger('click');

                            // call onChange handler manually
                            onFilterChange();
                        });
                    }
                });


                /*
                 * Expand/collapse top-level category.
                 */
                 $('.category > label, .category > .icon').click(function() {
                    var $subcategories_ul = $(this).parent().find('ul');
                    var $category_li = $subcategories_ul.parent();

                    if (($subcategories_ul).is(':visible')) {
                        $subcategories_ul.slideUp();
                        $category_li.removeClass('expanded');
                    }
                    else {
                        $subcategories_ul.slideDown();
                        $category_li.addClass('expanded');
                    }
                });


                /*
                 * All filters on.
                 */
                $('#filters-all-on').click(function(e) {
                    e.preventDefault();

                    doWithoutFilterEvents(function() {
                        $('.filters .subcategories :checkbox:not(:checked)').trigger('click');
                        $('.filters .category > :checkbox:not(:checked)').trigger('click');

                        // call onChange handler manually
                        onFilterChange();
                    });

                    return false;
                });


                /*
                 * All filters on.
                 */
                $('#filters-all-off').click(function(e) {
                    e.preventDefault();

                    doWithoutFilterEvents(function() {
                        $('.filters .subcategories :checkbox:checked').trigger('click');
                        $('.filters .category > :checkbox:checked').trigger('click');

                        // call onChange handler manually
                        onFilterChange();
                    });

                    return false;
                });

            });
        </script>

    </head>

    <body>
        <div id="header">
            <h1>Berlin Freir√§ume</h1>
        </div>

        <div class="grid grid-3-4">
            <div id="map"></div>
        </div>
        <div class="grid grid-1-4">
            <div class="clear filter-actions">
                <a href="#" id="filters-all-on">all on</a> / <a href="#" id="filters-all-off">all off</a><br />
                <input id="grow" name="grow" type="checkbox" /><label for="grow">grow dots by category</label>
            </div>
            <ul class="filters"></ul>
        </div>
        <div class="clear"></div>

        <div id="list"></div>

    </body>

</html>
